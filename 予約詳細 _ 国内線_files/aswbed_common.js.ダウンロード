/**
 * @fileoverview 「aswbed_common.js」全ての画面で共通で使用するJavaScriptのみ記述
 *
 * @require  jQuery1.8.3
 * @version  0.06
 * @update   2015/8/24
 */


/**
 * @namespace ASW共通のオブジェクト<br>
 */
var Aswbed = Aswbed || {};

/**
 * 全画面共通の画面下部にあるような、トグル式で表示を切り替えるメソッド(汎用)<br>
 *
 * HTML設置例）
 * <code>
 *   $('.infoBox.importantInfo .toggleSwitch').on('click' , function(){
 *        Aswbed.switchDisplay(this,['.infoBox.importantInfo .toggleContents']);
 *    });
 * </code>
 *
 * @param {Object} _this shatterInfoメソッドを実行した要素 'data-boolean'という判定用属性を設置する場所として使用。<br>
 * @param {Array} targetAry 表示と非表示を切り替える対象のjQueryセレクタ名 複数設定できるように、セレクタ名の文字列が入った配列で設定する。<br>
 * ※注意　表示・非表示を切り替えるセレクタ名は、ページ内でユニークになるように、セレクタ名を設定しないと、一度に複数の要素が表示されます
 */
Aswbed.switchDisplay = function (_this, targetAry) {
    'use strict';

    var $target = $(Aswbed.escapeForIdSelectorString(_this));
    var dataBoolean = $target.attr('data-boolean');
    var verticality = 'top';
    var horizontality = 'right';
    var i;
    var j;

    if (dataBoolean === undefined) {
        dataBoolean = 'false';
    }
    dataBoolean = (dataBoolean === 'true') ? 'false' : 'true';
    $target.attr('data-boolean', dataBoolean);

    if (dataBoolean == 'true') {
        verticality = 'bottom';
        for (i = 0, j = targetAry.length; i < j; i++) {
            $(Aswbed.escapeForIdSelectorString(targetAry[i])).show();
        }
    } else {
        verticality = 'top';
        for (i = 0, j = targetAry.length; i < j; i++) {
            $(Aswbed.escapeForIdSelectorString(targetAry[i])).hide();
        }
    }

    $target.css('background-position', horizontality + ' ' + verticality);
    $target.off('mouseenter mouseleave');
    $target.on({
        'mouseenter': function () {
            horizontality = 'right';
            $target.css('background-position', horizontality + ' ' + verticality);
        },
        'mouseleave': function () {
            horizontality = 'left';
            $target.css('background-position', horizontality + ' ' + verticality);
        }
    });
};



/**
 * jQueryのセレクタでID指定時用に「:」「[」「]」を"\\"でエスケープした文字に変換して返却します。<br>
 *
 * 注意<br>
 * composite component使用等で、ID属性に上記の「:」「[」「]」が含まれる場合にご利用ください。<br>
 * ex)<br>
 * <code>
 * $(Asw.escapeForIdSelectorString("#test.id:sample")).xxxxxx;
 * </code>
 *
 * @param {String or Object} targetObject エスケープ対象文字列とオブジェクト
 * @returns {String} エスケープ処理後の文字列
 */
Aswbed.escapeForIdSelectorString = function (targetObject) {
    'use strict';

    if (typeof targetObject === 'string') {
        //先頭に「#」があるものだけエスケープ
        if (/(^#)/.test(targetObject)) {
            var selectorString = targetObject.slice(0, 1);
            var replacementString = targetObject.slice(1).replace(/(:|\[|\])/g, '\\$1');
            return selectorString + replacementString;
        } else {
            return targetObject;
        }
    }
    //それ以外はそのまま返す
    else {
        return targetObject;
    }
};

/**
 * IEにおいてplaceholderに実際に値を入れている。送信時にplaceholder値とみなしたものを削除するメソッド<br>
 *
 * <code>
 * <input type="submit" onclick="Aswbed.clearPlaceholder();formdata.submit();return false;"
 * </code>
 *
 */
Aswbed.clearPlaceholder = function(){
    'use strict';
    $('[placeholder]').each(function () {
        var input = $(this);
        if (input.val() === input.attr('placeholder')) {
            input.val('');
        }
    });
};





/**
 * Back Forward Cache(戻るボタン押下時のJavascript実行後状態キャッシュ)機能を強制的に無効化します
 */
window.onunload = function () {};





/**
 * 画像へのロールオーバー時にロールオーバー用画像に切り替えるメソッド
 *
 * <code>
 * Aswbed.toggleImageRollOver();
 * </code>
 *
 * @param {String} selector セレクタ
 * @returns {void}
 *
 */
Aswbed.toggleImageRollOver = function (selector) {
	'use strict';
	var currentSelector = '.jsRollOver';
	var preLoad = {};
	var hoverSuffix = '_hover';
	var imageRegex = new RegExp(hoverSuffix, 'g');

	if (selector !== void 0 && selector !== '') {
		currentSelector = selector;
	}

	// プレロード
	$(currentSelector).each(function () {
		var imageSource = $(this).attr('src');
		var extension = imageSource.substring(imageSource.lastIndexOf('.'));
		var noExtensionImageSource = imageSource.substr(0, imageSource.lastIndexOf('.'));

		preLoad[this.src] = new Image();
		preLoad[this.src].src = noExtensionImageSource + hoverSuffix + extension;
	});

	// イベント設定
	$(document).off('mouseenter.jsRollOver', currentSelector);
	$(document).on('mouseenter.jsRollOver', currentSelector, function () {
		var imageSource = $(this).attr('src');
		var extension;
		var noExtensionImageSource;

		// リセット
		$(this).attr('src', imageSource.replace(imageRegex, ''));

		imageSource = $(this).attr('src');
		extension = imageSource.substring(imageSource.lastIndexOf('.'));
		noExtensionImageSource = imageSource.substr(0, imageSource.lastIndexOf('.'));

		$(this).attr('src', noExtensionImageSource + hoverSuffix + extension);
	});

	$(document).off('mouseleave.jsRollOver', currentSelector);
	$(document).on('mouseleave.jsRollOver', currentSelector, function () {
		var imageSource = $(this).attr('src');

		$(this).attr('src', imageSource.replace(imageRegex, ''));
	});

};

$(function () {
	'use strict';
	Aswbed.toggleImageRollOver('.jsRollOver');
});






/**
 * リンクにロールオーバーした際に内部の画像をロールオーバー用画像に切り替えるメソッド
 *
 * <code>
 * Aswbed.toggleImageRollOver();
 * </code>
 *
 * @param {String} selector セレクタ
 * @returns {void}
 *
 */
Aswbed.toggleImageRollOverInLink = function (selector) {
    'use strict';
    // リンクのセレクタ
	var currentSelector = '.jsRollOverInLink';
    // リンク内に存在しているロールオーバー時に切り替える画像のセレクタ
    var childSelector = '.jsRollOverImg';
    // プリロード画像格納用
	var preLoad = {};
    // hover時のプレフィクス
    var hoverSuffix = '_hover';
    // mouseleave時に画像からhover時のプレフィクスを削除する為の正規表現
	var imageRegex = new RegExp(hoverSuffix, 'g');

	if (selector !== void 0 && selector !== '') {
		currentSelector = selector;
    }

	// プリロード
	$(currentSelector).each(function () {
		var imageSource = $(this).find(childSelector).attr('src');
		var extension = imageSource.substring(imageSource.lastIndexOf('.'));
		var noExtensionImageSource = imageSource.substr(0, imageSource.lastIndexOf('.'));

		preLoad[$(this).find(childSelector)[0].src] = new Image();
        preLoad[$(this).find(childSelector)[0].src].src = noExtensionImageSource + hoverSuffix + extension;
	});
    
    
	// リンクにロールオーバー時、内部の「.jsRollOverImg」画像をロールオーバー画像へ切り替える
	$(document).on('mouseenter', currentSelector, function () {
        var imageSource = $(this).find(childSelector).attr('src');
		var extension;
		var noExtensionImageSource;

		// リセット
		$(this).find(childSelector).attr('src', imageSource.replace(imageRegex, ''));

		imageSource = $(this).find(childSelector).attr('src');
		extension = imageSource.substring(imageSource.lastIndexOf('.'));
		noExtensionImageSource = imageSource.substr(0, imageSource.lastIndexOf('.'));

		$(this).find(childSelector).attr('src', noExtensionImageSource + hoverSuffix + extension);
	});

	// リンクからロールアウト時、内部の「.jsRollOverImg」画像を通常画像へ切り替える
	$(document).on('mouseleave', currentSelector, function () {
		var imageSource = $(this).find(childSelector).attr('src');

		$(this).find(childSelector).attr('src', imageSource.replace(imageRegex, ''));
	});

};

$(function () {
	'use strict';
	Aswbed.toggleImageRollOverInLink('.jsRollOverInLink');
});






/**
 * アイコン画像マウスオーバーするとinputもホバー状態にする<br>
 * アイコン画像クリックすると内部のinputをクリックされるメソッド
 *
 * <code>
 * Aswbed.clickImageOnInput();
 * </code>
 * @param {String} taeget ボタンをwrapしている要素
 */
Aswbed.clickImageOnInput = function() {

    // 要素内にspanが存在しない場合は実行しない
    if($('.btnIconWrap').find('span').length != 0) {
        // btnIconWrap内のspanにマウスエンター、マウスリーヴした場合
        $('.btnIconWrap').find('span').on({
            'mouseenter': function () {
                // 直近の親要素「btnIconWrap」のタグ内のinputタグを確認
                var inputSubmit = $(this).closest('.btnIconWrap').find('input');
                // inputにhover用classを付与する
                inputSubmit.addClass('btnHover');
            },
            'mouseleave' : function(){
                // 直近の親要素「btnIconWrap」のタグ内のinputタグを確認
                var inputSubmit = $(this).closest('.btnIconWrap').find('input');
                // inputからhover用classを削除する
                inputSubmit.removeClass('btnHover');
            }
        });
    }
    
    // 要素内にimgが存在した場合
    if( $('.btnIconWrap').find('img').length != 0) {
        // btnIconWrap内のimgをクリックした際
        $('.btnIconWrap').find('img').on('click', function () {

            // 直近の親要素「btnIconWrap」のタグ内のinputタグを確認
            var inputSubmit = $(this).closest('.btnIconWrap').find('input');

            // 直近の親要素「btnIconWrap」のタグを判定する
            // 親要素がAタグ以外、かつ内部にinput が存在した場合のみ実行する
            if ( $(this).closest('.btnIconWrap')[0].tagName !== 'A' && inputSubmit.length != 0) {
                inputSubmit.focus().trigger('click');
            }
        });
    }
};

$(function(){
    // input ボタンの上にのった画像もクリック可能にするメソッド
    Aswbed.clickImageOnInput();
});


/**
 * アコーディオン用のメソッド（重要なお知らせ、ご利用のヒントの開閉）
 *
 * HTML設置例）
 * <code>
 *  <a href="#" class="triggerSwitch jsTriggerSwitch" aria-controls="informationMessages" aria-expanded="false"><img src="image/btn/toggle_open.png?2a1bcbd" class="jsRollOver" alt="開く" width="25" height="25"></a>
 * </code>
 * @param baseSelector 親となるクラス名指定
 * @param configuration.triggerSwitch クリックボタンのクラス名
 * @param configuration.listClass ターゲットとなるリストのクラス名
 * @param configuration.visibilityHidden 非表示用のクラス名（addClass and removeClass）
 *
 * jsAccordionSwitch アコーディオンする部分の親クラス
 * jsTriggerSwitch 開閉処理のボタン要素のクラス
 * jsAccordionSwitchList 非表示要素の親クラス
 * jsHiddenFlg 非表示要素のフラグ用クラス
 */
Aswbed.AccordionInfo = function(baseSelector, configuration){
    var base = Aswbed.escapeForIdSelectorString(baseSelector);
    var $triggerSwitch = $(configuration.triggerSwitch);
    var flagClassName = '.jsHiddenFlg';
    var isOpenClass = 'isOpen';
    var triggerText = [Aswbed.GlobalWord.accodionOpenIconAltText, Aswbed.GlobalWord.accodionCloseIconAltText];
    var ariaExpanded = [false, true];
    /*
    * 初期値（.jsHiddenFlgがある要素にconfiguration.visibilityHiddenを付与）
    */
    $triggerSwitch.each(function(){
        $(this).parents(baseSelector).find(configuration.listClass).children(flagClassName).addClass(configuration.visibilityHidden);
        $(this).children().attr('alt', triggerText[0]);
    });
    /*
    * Click Event（isOpenで判定して状態を切替）
    */
    $triggerSwitch.on('click', function(){
        var $targetList = $(this).parents(baseSelector).find(configuration.listClass).children();
        var listIndex = $targetList.length;
        var listHiddenIndex = $(this).parents(baseSelector).find(configuration.listClass).children(flagClassName).length;
        var sliceNumber = listIndex - listHiddenIndex;
        var $targetImg = $(this).children();
        if ($(this).hasClass(isOpenClass)) {
            $targetImg.attr('src', $targetImg.attr('src').replace('_close.', '_open.').replace('_close_', '_open_'));
            $(this).removeClass(isOpenClass).attr('aria-expanded', ariaExpanded[0]).children().attr('alt', triggerText[0]);
            $targetList.slice(sliceNumber).addClass(configuration.visibilityHidden);
            if($(this).closest(baseSelector).find('.infoBoxMoreText').length > 0){
                $(this).closest(baseSelector).find('.infoBoxMoreText').show();
            }
        } else {
            $targetImg.attr('src', $targetImg.attr('src').replace('_open.', '_close.').replace('_open_', '_close_'));
            $(this).addClass(isOpenClass).attr('aria-expanded', ariaExpanded[1]).children().attr('alt', triggerText[1]);
            $targetList.removeClass(configuration.visibilityHidden);
            $(this).closest(baseSelector).find(configuration.listClass).children(flagClassName).eq(0).attr('tabindex','-1').focus();
            if($(this).closest(baseSelector).find('.infoBoxMoreText').length > 0){
                $(this).closest(baseSelector).find('.infoBoxMoreText').hide();
            }
        }
        return false;
    });
};


/**
 * アンカーリンク先にフォーカスを移動
 *
 * HTML設置例）
 * <code>
 *  <a href="#anchorLinkId" class="jsAnchorFocusJump">アンカーリンク</a>
 * </code>
 */
Aswbed.anchorFocusJump = function() {
    'use strict';

    $('.jsAnchorFocusJump').on('click', function () {
        var href = $(this).attr('href');
        if($(href).length) {
            $(href).addClass('focusHidden').attr('tabindex','-1').focus();
        }
    });
};

$(function(){
    'use strict';
    Aswbed.anchorFocusJump();
});
